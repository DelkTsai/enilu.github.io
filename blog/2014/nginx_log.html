<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
    <meta charset="utf-8" />
    <title>enilu的技术博客 | Apache James快速部署</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="技术博客,enilu的技术博客,apache james,邮箱搭建" name="keywords" />
    <meta content="enilu的技术博客，欢迎批评指正,apache james" name="description">
    <meta content="enilu" name="author" />

    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="../../assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <!-- END GLOBAL MANDATORY STYLES -->

    <!-- BEGIN PAGE LEVEL PLUGIN STYLES -->
    <link href="../../assets/plugins/fancybox/source/jquery.fancybox.css" rel="stylesheet" />
    <!-- END PAGE LEVEL PLUGIN STYLES -->

    <!-- BEGIN THEME STYLES -->
    <link href="../../assets/css/style-metronic.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/css/themes/blue.css" rel="stylesheet" type="text/css" id="style_color"/>
    <link href="../../assets/css/style-responsive.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/css/custom.css" rel="stylesheet" type="text/css"/>
    <!-- END THEME STYLES -->

    <link rel="shortcut icon" href="favicon.ico" />
</head>
<!-- END HEAD -->

<!-- BEGIN BODY -->
<body>
<!-- BEGIN STYLE CUSTOMIZER -->
<div class="color-panel hidden-sm">
    <div class="color-mode-icons icon-color"></div>
    <div class="color-mode-icons icon-color-close"></div>
    <div class="color-mode">
        <p>THEME COLOR</p>
        <ul class="inline">
            <li class="color-blue current color-default" data-style="blue"></li>
            <li class="color-red" data-style="red"></li>
            <li class="color-green" data-style="green"></li>
            <li class="color-orange" data-style="orange"></li>
        </ul>
        <label>
            <span>Header</span>
            <select class="header-option form-control input-small">
                <option value="default" selected>Default</option>
                <option value="fixed">Fixed</option>
            </select>
        </label>
    </div>
</div>
<!-- END BEGIN STYLE CUSTOMIZER -->

<!-- BEGIN HEADER -->
<div class="header navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <!-- BEGIN RESPONSIVE MENU TOGGLER -->
            <button class="navbar-toggle btn navbar-btn" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <!-- END RESPONSIVE MENU TOGGLER -->
            <!-- BEGIN LOGO (you can use logo image instead of text)-->
            <a class="navbar-brand logo-v1" href="index.html">
                <img src="../../assets/img/logo_blue.png" id="logoimg" alt="" style="width:200px;height:60px">
            </a>
            <!-- END LOGO -->
        </div>

        <!-- BEGIN TOP NAVIGATION MENU -->
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="../../index.html" target="_blank">首页</a></li>
                <li class="active"><a href="../../index.html">博客</a></li>
                <li><a href="hot_article.html">精选转载</a></li>
                <li><a href="#">举个栗子</a></li>


                <li class="menu-search">
                    <span class="sep"></span>
                    <i class="fa fa-search search-btn"></i>

                    <div class="search-box">
                        <form action="#">
                            <div class="input-group input-large">
                                <input class="form-control" type="text" placeholder="Search">
                                    <span class="input-group-btn">
                                        <button type="submit" class="btn theme-btn">Go</button>
                                    </span>
                            </div>
                        </form>
                    </div>
                </li>
            </ul>
        </div>
        <!-- BEGIN TOP NAVIGATION MENU -->
    </div>
</div>
<!-- END HEADER -->

<!-- BEGIN PAGE CONTAINER -->
<div class="page-container">

    <!-- BEGIN BREADCRUMBS -->
    <div class="row breadcrumbs margin-bottom-40">
        <div class="container">
            <div class="col-md-4 col-sm-4">
                <h1>通过统计nginx访问日志禁止恶意抓取数据的实现 </h1>
            </div>
            <div class="col-md-8 col-sm-8">
                <ul class="pull-right breadcrumb">
                    <li><a href="../../index.html">首页</a></li>
                    <li><a href="../../index.html">博客</a></li>
                    <li class="active">文章详情</li>

                </ul>
            </div>
        </div>
    </div>
    <!-- END BREADCRUMBS -->

    <!-- BEGIN CONTAINER -->
    <div class="container min-hight">
        <!-- BEGIN BLOG -->
        <div class="row">
            <!-- BEGIN LEFT SIDEBAR -->
            <div class="col-md-9 blog-item margin-bottom-40">
                <p>
                    nginx默认会记录客户端访问服务端的日志，默认的目录位于：/var/logs/access.log;<br><br>

                    业务需求：每小时读取access.log内容，统计每个ipd访问系统次数，如果超过指定次数，则将该ip加入到防火墙中，以便禁止其继续访问（后续可以考虑不是禁止其访问服务，而是重定向到指定的页面）。这样避免别人恶意从自己网站上抓取数据
<pre>
<code>

#-*-coding:utf8 -*-
import logging,datetime,os,sys,string,re
reload(sys)
sys.setdefaultencoding('utf8')
logging.basicConfig(level=logging.DEBUG, \
                    format='%(asctime)s %(levelname)s- %(message)s', \
		    filename='/data/analyse.log', \
                    datefmt='%m-%d %H:%M', \
                    )
#单位时间内允许最大有效访问次数
maxallowednum=500
ipDic={}
pip = re.compile('[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
ptime = re.compile('[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}')
logfilepath = '/var/log/nginx/access.log'
#该文件记录上次访问到的日志行数
tmpfilepath ='/data/tmp'

linenum = string.atoi(open(tmpfilepath,'r').read())
#读取文件总行数，如果总行数小于tmp文件中记录的行数，说明该日志文件微新增的日志文件，则需要从第一行开始读取
loglinenum = len(open(logfilepath,'rU').readlines())
if(loglinenum<linenum):
    linenum = 1

logging.debug('linenum is:%s',linenum)

logfile = open(logfilepath,'r')
tmpfile = open(tmpfilepath,'w')

index = 0
line = logfile.readline()
while(line!=''):
    if(index>=linenum):
        #print line
  	 mip = pip.search(line)
	 #mtime = ptime.search(line)
	 if mip:
	     ip = mip.group()
             #将每个ip的有效请求存放在ipDic字典中
	     if(line.find('/static/')==-1):
 	         if(ipDic.has_key(ip)):
	             ipDic[ip] = ipDic[ip]+1
                 else:
		     ipDic[ip] = 1

	     #times = mtime.group()
	     #logging.debug('%s' %(ip))

    line=logfile.readline()
    index+=1

logging.debug('new line num:%i'%(index))
tmpfile.write(str(index))
tmpfile.close()
logfile.close()
#循环ip字典，将其中访问次数超过最大允许访问次数的ip加入到防火墙，禁止其继续访问
for k,v in ipDic.items():
    if(v>=maxallowednum):
        logging.debug('ip:%s visited %i times,add to iptables' %(k,v))
        os.system('iptables -I INPUT 1 -s '+k+' -j DROP')
    else:
	logging.debug('ip:%s visited %i times' %(k,v))

logging.debug('-------------------------over------------------------------');
</code>
</pre>
                </p>

                <ul class="blog-info">
                    <li><i class="fa fa-user"></i> By enilu</li>
                    <li><i class="fa fa-calendar"></i> 25/09/2014</li>
                    <li><i class="fa fa-comments"></i> 0</li>
                    <li><i class="fa fa-tags"></i> nginx,log,python</li>
                </ul>


                <div class="post-comment">

                    <form role="form">

                        <p><a class="btn btn-default theme-btn" href="mailto:eniluzt@qq.com">联系我</a></p>
                    </form>
                </div>
            </div>
            <!-- END LEFT SIDEBAR -->

            <!-- BEGIN RIGHT SIDEBAR -->
            <div class="col-md-3 blog-sidebar">
                <h2>分类</h2>
                <ul class="nav sidebar-categories margin-bottom-40">

                </ul>

                <!-- CATEGORIES END -->

                <!-- BEGIN RECENT NEWS -->
                <h2>热门文章</h2>
                <div class="recent-news margin-bottom-10">
                    <div class="row margin-bottom-10">

                        <div class="col-md-12 recent-news-inner">
                            <h3><a href="#">Letiusto gnissimos</a></h3>
                            <p>Decusamus tiusto odiodig nis simos ducimus qui sint</p>
                        </div>
                    </div>
                    <div class="row margin-bottom-10">

                        <div class="col-md-12 recent-news-inner">
                            <h3><a href="#">Letiusto gnissimos</a></h3>
                            <p>Decusamus tiusto odiodig nis simos ducimus qui sint</p>
                        </div>
                    </div>
                    <div class="row margin-bottom-10">

                        <div class="col-md-12 recent-news-inner">
                            <h3><a href="#"></a></h3>
                            <p></p>
                        </div>
                    </div>
                    <div class="row margin-bottom-10">

                        <div class="col-md-12 recent-news-inner">
                            <h3><a href="#"></a></h3>
                            <p></p>
                        </div>
                    </div>
                    <div class="row margin-bottom-10">

                        <div class="col-md-12 recent-news-inner">
                            <h3><a href="#"></a></h3>
                            <p></p>
                        </div>
                    </div>

                </div>
                <!-- END RECENT NEWS -->


                <!-- BEGIN BLOG TAGS -->
                <div class="blog-tags margin-bottom-20">
                    <h2>热门标签</h2>
                    <ul>

                    </ul>
                </div>
                <!-- END BLOG TAGS -->
            </div>
            <!-- END RIGHT SIDEBAR -->
        </div>
        <!-- END BEGIN BLOG -->
    </div>
    <!-- END CONTAINER -->

</div>
<!-- END BEGIN PAGE CONTAINER -->


<!-- BEGIN FOOTER -->
<div class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-sm-4 space-mobile">
                <!-- BEGIN ABOUT -->
                <h2>关于我</h2>
                <p class="margin-bottom-30">年近三十而不立；身为笨鸟而不先飞；知错而不悔改；空谈梦想而不行动；是也。</p>
                <div class="clearfix"></div>
                <!-- END ABOUT -->
            </div>
            <div class="col-md-4 col-sm-4 space-mobile">
                <!-- BEGIN CONTACTS -->
                <h2>联系我</h2>
                <address class="margin-bottom-40">
                    easecredit. <br />
                    北京.朝阳 <br />

                    QQ:909051758 <br />
                    Email: <a href="mailto:eniluzt@qq.com">eniluzt@qq.com</a>
                </address>

            </div>
            <div class="col-md-4 col-sm-4 space-mobile">
                <!-- BEGIN CONTACTS -->
                <h2>友情链接</h2>
                <address class="margin-bottom-40">
                    网站使用metronic模版，感谢，<a target="_blank" href="http://themeforest.net/item/metronic-responsive-admin-dashboard-template/4021469">go to metronic</a>  </address>
            </div>

        </div>
    </div>
</div>
<!-- END FOOTER -->

<!-- BEGIN COPYRIGHT -->
<div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <p>
                    <span class="margin-right-10">2015 © eniluzt. ALL Rights Reserved.</span>

                </p>
            </div>

        </div>
    </div>
</div>
<!-- END COPYRIGHT -->

<!-- Load javascripts at bottom, this will reduce page load time -->
<!-- BEGIN CORE PLUGINS(REQUIRED FOR ALL PAGES) -->
<!--[if lt IE 9]>
<script src="../../assets/plugins/respond.min.js"></script>
<![endif]-->
<script src="../../assets/plugins/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="../../assets/plugins/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>
<script src="../../assets/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script type="text/javascript" src="../../assets/plugins/hover-dropdown.js"></script>
<script type="text/javascript" src="../../assets/plugins/back-to-top.js"></script>
<!-- END CORE PLUGINS -->

<!-- BEGIN PAGE LEVEL JAVASCRIPTS(REQUIRED ONLY FOR CURRENT PAGE) -->
<script type="text/javascript" src="../../assets/plugins/fancybox/source/jquery.fancybox.pack.js"></script>
<script src="../../assets/scripts/app.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function() {
        App.init();
    });
</script>
<script type="text/javascript" src="../../assets/scripts/blog.js"></script>
<!-- END PAGE LEVEL JAVASCRIPTS -->
</body>
<!-- END BODY -->
</html>
